import{A as D}from"./index.CkikM9n_.js";import{r as E}from"./scheduler.Cm-2GWLV.js";import{s as a}from"./supabase.C3Npp-7Q.js";function W(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function b(e,t){e.d(1),t.delete(e.key)}function F(e,t,s,r,d,_,n,p,h,I,c,l){let o=e.length,w=_.length,f=o;const S={};for(;f--;)S[e[f].key]=f;const y=[],A=new Map,O=new Map,k=[];for(f=w;f--;){const i=l(d,_,f),u=s(i);let m=n.get(u);m?k.push(()=>m.p(i,t)):(m=I(u,i),m.c()),A.set(u,y[f]=m),u in S&&O.set(u,Math.abs(f-S[u]))}const M=new Set,C=new Set;function v(i){D(i,1),i.m(p,c),n.set(i.key,i),c=i.first,w--}for(;o&&w;){const i=y[w-1],u=e[o-1],m=i.key,q=u.key;i===u?(c=i.first,o--,w--):A.has(q)?!n.has(m)||M.has(m)?v(i):C.has(q)?o--:O.get(m)>O.get(q)?(C.add(m),v(i)):(M.add(q),o--):(h(u,n),o--)}for(;o--;){const i=e[o];A.has(i.key)||h(i,n)}for(;w;)v(y[w-1]);return E(k),y}function g(){if(typeof window>"u")return"";let e=localStorage.getItem("session_id");return e||(e="sess_"+Math.random().toString(36).substring(2)+Date.now().toString(36),localStorage.setItem("session_id",e)),e}function x(){const e=Date.now()%1e5,t=Math.floor(Math.random()*1e3);return`3DK-${e}-${t}`}const K={async getAll(e){let t=a.from("products").select("*").order("id");e&&e!=="All"&&(t=t.eq("category",e));const{data:s,error:r}=await t;if(r)throw r;return s||[]},async getById(e){const{data:t,error:s}=await a.from("products").select("*").eq("id",e).single();if(s)throw s;return t},async create(e){const{data:t,error:s}=await a.from("products").insert([e]).select().single();if(s)throw s;return t},async update(e,t){const{data:s,error:r}=await a.from("products").update(t).eq("id",e).select().single();if(r)throw r;return s},async delete(e){const{error:t}=await a.from("products").delete().eq("id",e);if(t)throw t}},R={async get(){const e=g(),{data:t,error:s}=await a.from("cart_items").select(`
        id,
        session_id,
        product_id,
        quantity,
        products (*)
      `).eq("session_id",e);if(s)throw s;return(t||[]).map(r=>({id:r.id,session_id:r.session_id,product_id:r.product_id,quantity:r.quantity,product:r.products}))},async add(e,t=1){const s=g(),{data:r}=await a.from("cart_items").select("*").eq("session_id",s).eq("product_id",e).single();return r?await a.from("cart_items").update({quantity:r.quantity+t}).eq("id",r.id):await a.from("cart_items").insert([{session_id:s,product_id:e,quantity:t}]),{message:"Added to cart!"}},async update(e,t){const s=g();return t<=0?await a.from("cart_items").delete().eq("id",e).eq("session_id",s):await a.from("cart_items").update({quantity:t}).eq("id",e).eq("session_id",s),{message:"Cart updated!"}},async remove(e){const t=g();await a.from("cart_items").delete().eq("id",e).eq("session_id",t)},async clear(){const e=g();await a.from("cart_items").delete().eq("session_id",e)}},T={async create(e){const t=g(),{data:s,error:r}=await a.from("cart_items").select(`
        id,
        product_id,
        quantity,
        products (id, name, price)
      `).eq("session_id",t);if(r)throw r;if(!s||s.length===0)throw new Error("Cart is empty");let d=0;const _=s.map(c=>{const l=c.products,o=(l==null?void 0:l.price)||0;return d+=o*c.quantity,{product_id:c.product_id,product_name:(l==null?void 0:l.name)||"Unknown",price:o,quantity:c.quantity}}),n=x(),{data:p,error:h}=await a.from("orders").insert([{session_id:t,customer_name:e.customer_name,customer_email:e.customer_email,address:e.address,total:d,status:"pending",tracking_code:n}]).select().single();if(h)throw h;const I=_.map(c=>({...c,order_id:p.id}));return await a.from("order_items").insert(I),await a.from("status_history").insert([{order_id:p.id,status:"pending",message:"Order received! We're reviewing it. ðŸŽ‰"}]),await a.from("cart_items").delete().eq("session_id",t),{...p,items:_}},async getById(e){const{data:t,error:s}=await a.from("orders").select(`
        *,
        order_items (*)
      `).eq("id",e).single();if(s)throw s;return{...t,items:t.order_items||[]}},async track(e){const{data:t,error:s}=await a.from("orders").select(`
        *,
        order_items (*)
      `).eq("tracking_code",e).single();if(s)throw s;const{data:r}=await a.from("status_history").select("status, message, created_at").eq("order_id",t.id).order("created_at",{ascending:!1});return{order:{...t,items:t.order_items||[]},status_history:(r||[]).map(d=>({status:d.status,message:d.message,timestamp:d.created_at}))}}},U={async getOrders(){const{data:e,error:t}=await a.from("orders").select(`
        *,
        order_items (*)
      `).order("created_at",{ascending:!1});if(t)throw t;return(e||[]).map(s=>({...s,items:s.order_items||[]}))},async updateOrderStatus(e,t,s){const{error:r}=await a.from("orders").update({status:t,updated_at:new Date().toISOString()}).eq("id",e);if(r)throw r;return await a.from("status_history").insert([{order_id:e,status:t,message:s||`Status updated to ${t}`}]),{message:"Order updated!"}},async getStats(){const{count:e}=await a.from("products").select("*",{count:"exact",head:!0}),{data:t}=await a.from("orders").select("status, total"),s=(t==null?void 0:t.length)||0,r=["pending","confirmed","printing","printed","quality_check","ready"],d=(t==null?void 0:t.filter(n=>r.includes(n.status)).length)||0,_=(t==null?void 0:t.filter(n=>n.status==="delivered").reduce((n,p)=>n+parseFloat(p.total||"0"),0))||0;return{total_products:e||0,total_orders:s,pending_orders:d,total_revenue:_}},async getOrderHistory(e){const{data:t,error:s}=await a.from("status_history").select("status, message, created_at").eq("order_id",e).order("created_at",{ascending:!1});if(s)throw s;return(t||[]).map(r=>({status:r.status,message:r.message,timestamp:r.created_at}))}};export{U as a,R as c,b as d,W as e,T as o,K as p,F as u};
